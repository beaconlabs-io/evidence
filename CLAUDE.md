# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Evidence Repository** for Beacon Labs - a collection of structured research evidence stored in MDX format. Evidence files are uploaded to IPFS (via Pinata) and attested on-chain using the Ethereum Attestation Service (EAS) on Base Sepolia.

## Repository Structure

```
src/
  index.ts              # Main entry point (npm package)
  types.ts              # Zod schemas and TypeScript types (CANONICAL)
  content/
    index.ts            # Content accessor API
    evidence.ts         # Generated: bundled MDX content
    deployments.ts      # Generated: bundled deployment metadata
types/
  index.ts              # Re-exports from src/types.ts (CI/CD compatibility)
evidence/               # MDX evidence files (e.g., 00.mdx, 01.mdx)
deployments/            # JSON deployment records with IPFS hashes and attestation UIDs
scripts/
  bundle-content.ts     # Build script (generates content/*.ts)
.github/
  scripts/              # Automation scripts for GitHub Actions
    comment.js          # PR comment helper (update or create)
    eas.js              # EAS attestation creation (Base Sepolia)
    pinata.js           # IPFS upload via Pinata
    validate-evidence.ts  # Zod-based evidence validation
  workflows/
    evidence-validation.yml   # PR validation on `main` branch
    evidence-attestation.yml  # Attestation via `/attest` command
```

## Architecture Best Practices

### Single Source of Truth for Types

- **Canonical location**: `src/types.ts` - All Zod schemas and TypeScript types
- **Re-export for compatibility**: `types/index.ts` - Re-exports from `src/types.ts`
- **Reason**: `tsconfig.build.json` sets `rootDir: "src"`, so npm package builds require types in `src/`

```
src/types.ts (canonical) ──re-export──▶ types/index.ts (CI/CD compatibility)
       │                                        │
       ▼                                        ▼
  npm package                        .github/scripts/validate-evidence.ts
```

### Generated Files (Do Not Edit)

These files are auto-generated and should not be manually edited:

- `src/content/evidence.ts` - Generated by `scripts/bundle-content.ts`
- `src/content/deployments.ts` - Generated by `scripts/bundle-content.ts`

## Evidence File Format

Evidence files are MDX with YAML frontmatter. Required fields:

- `evidence_id`: Unique identifier (e.g., "00")
- `title`: Research title (**max 200 chars**)
- `results`: Array of intervention outcomes
  - `intervention`: Brief description of treatment (**max 80 chars**)
  - `outcome_variable`: Measured variable name (**max 50 chars**)
  - `outcome`: Effect type (`N/A`, `+`, `-`, `+-`, `!`)
- `strength`: Evidence strength rating (0-5, Maryland SMS scale)
- `methodologies`: Array of research methodologies
- `citation`: Array of citation objects with `type`, `name`, `src`
- `date`: Publication date (YYYY-MM-DD format)
- `author`: Author name (**max 100 chars**)

Optional fields:

- `version`: Semantic version
- `datasets`: Array of dataset descriptions
- `tags`: Array of categorization tags

**Important:** Keep frontmatter fields concise. Detailed explanations belong in the MDX body content (Background, Analysis Method sections).

## Development Commands

```bash
# Install dependencies (uses Bun)
bun install

# Build npm package (bundle content + compile TypeScript)
bun run build

# Run TypeScript type checking
bun run typecheck

# Run evidence validation locally
BASE_BRANCH=main bun run .github/scripts/validate-evidence.ts
```

## CI/CD Workflow

1. **Evidence Validation** - Runs automatically on PRs targeting `main` that modify `evidence/*.mdx`
2. **Evidence Attestation** - Triggered by `/attest` comment on approved PRs (requires write permission)
   - Uploads evidence content to IPFS via Pinata
   - Creates EAS attestation on Base Sepolia
   - Updates deployment JSON with new attestation UID and IPFS hash
   - Commits deployment file back to PR branch

## Key Technical Details

- **EAS Contract**: `0x4200000000000000000000000000000000000021` (Base Sepolia)
- **Schema UID**: `0xaec128d2b0ed11303f1d7ca6c0a7387607b61f1181c36b378022b4fda73df68f`
- **Runtime**: Bun + Node.js 24.x
- **Validation**: Zod schema via `EvidenceFrontmatterSchema` from `src/types.ts`

## Required Secrets (GitHub Actions)

- `PINATA_JWT` - Pinata API token for IPFS uploads
- `PRIVATE_KEY` - Ethereum wallet private key for EAS attestations
